---
title: "PER EDA Lateralization"
author: "Ian Kahrilas"
date: "2/21/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(pander)
# load in erp dataset
erp <- read_csv("erp_data.csv")
```

This is a two dimensional view of our electrodes for our equidistant montage. The site of maximal activation for each condition are right lateralized at electrodes B23, B24, B26, and B27. Another site of activation in all conditions is left lateralized at electrodes A27, A26, A30, and A29. Our initial hypothesis was to measure LPP as a more centroparietal component at electrodes A25, B21, B22, an B28, which was more in line with previous literature on the component. This will serve as our centralized LPP.

```{r LPP sites, message = FALSE, include=FALSE}
elec_loc <- read_csv("Equidistant Layout.csv")
elec_loc <- elec_loc %>%
  rename("channel" = `channel name`) %>%
  filter(channel != "CMS", channel != "DRL")

elec_loc$radian_phi <- pi/180 * elec_loc$phi

elec_loc <- elec_loc %>%
  mutate(x = theta * cos(radian_phi),
         y = theta * sin(radian_phi))

# this is where our electrodes are
ggplot(elec_loc, aes(x, y, label = channel)) +
  geom_text() +
  theme_bw() +
  coord_equal()
```

Calculate LPP averages for each site (400 ms - 1000 ms) and merge with questionnaire data.
```{r calculation of LPP sites, include=FALSE}
erp_long <- gather(erp, key = "electrode", value = "mv", str_subset(names(erp), "[A-Z]"))

LPP_right <- erp_long %>%
  filter(electrode %in% c("B23", "B24", "B26", "B27"), between(ms, 400, 1000)) %>%
  group_by(pid, block) %>%
  summarize("LPP_right" = mean(mv, na.rm = TRUE))
LPP_left <- erp_long %>%
  filter(electrode %in% c("A27", "A26", "A30", "A29"), between(ms, 400, 1000)) %>%
  group_by(pid, block) %>%
  summarize("LPP_left" = mean(mv, na.rm = TRUE))
LPP_center <- erp_long %>%
  filter(electrode %in% c("A25", "B21", "B22", "B28"), between(ms, 400, 1000)) %>%
  group_by(pid, block) %>%
  summarize("LPP_center" = mean(mv, na.rm = TRUE))

LPP_total <- full_join(LPP_right, LPP_left, by = c("pid", "block")) %>%
  full_join(LPP_center, by = c("pid", "block"))

LPP_total$block <- as.factor(LPP_total$block)

per_int <- read_csv("per_measures.csv")

per_int$block <- as.factor(per_int$block) 

levels(per_int$block) <- c("Neg_Dec",
                           "Neg_Inc",
                           "Neg_Watch",
                           "Neu_Watch",
                           "Pos_Dec",
                           "Pos_Inc",
                           "Pos_Watch")

per_erp <- full_join(LPP_total, per_int, by = c("pid", "block"))

# remove outlier
per_erp <- per_erp %>% 
  filter(!(pid %in% c(206201843)))
```
The below table shows the means and SDs of LPP for each block across each electrode site. LPP averages are consistently larger in the right lateralized site. Variability is comparable.
```{r LPP descriptives}
per_erp %>% 
  group_by(block) %>% 
  summarize("Mean LPP Right" = mean(LPP_right, na.rm = TRUE),
            "SD LPP Right" = sd(LPP_right, na.rm = TRUE),
            "Mean LPP Left" = mean(LPP_left, na.rm = TRUE),
            "SD LPP Left" = sd(LPP_left, na.rm = TRUE),
            "Mean LPP Center" = mean(LPP_center, na.rm = TRUE),
            "SD LPP Center" = sd(LPP_center, na.rm = TRUE)) %>% 
  pander()
```
The below plot illustrates boxplots for LPP amplitudes in each block partitioned by electrode site. Again, this illustrates that the right lateralized site has the strongest activation, followed by left, then center.
```{r box plots for block partitioned by electrode site, warning = FALSE, message=FALSE, warning=FALSE}
# long form data for plotting
per_erp_long <- per_erp %>% 
  pivot_longer(LPP_right:LPP_center, names_to = "site", values_to = "LPP") %>% 
  mutate(site = str_remove(site, "LPP_"))

ggplot(per_erp_long, aes(block, LPP, color = site)) +
  geom_boxplot() + 
  ggtitle("LPP Averages for each Block Partitioned by Electrode Site")

```
To determine if any particular site does a better job explaining variance in LPP in our main study hypotheses, three different models will be fit that correspond to each main study hypotheses, each using LPP that is localized to various sites (left, right, center). The AIC for each of these models will be compared via ANOVA to determine if there are significant differences.
```{r prep block variable, include=FALSE}
per_erp_long$block <- relevel(per_erp_long$block, ref = "Neu_Watch")
per_erp_long$block <- relevel(per_erp$block, ref = "Neu_Watch") 
```
For hypothesis one, that positively- and negatively-valenced blocks elicit larger LPP than the neutral condition
```{r fit various models}
summary(lmerTest::lmer(LPP ~ block + (1|pid), data = filter(per_erp_long, site == "left")))
summary(lmerTest::lmer(LPP ~ block + (1|pid), data = filter(per_erp_long, site == "center")))
summary(lmerTest::lmer(LPP ~ block + (1|pid), data = filter(per_erp_long, site == "right")))
```
Models for hypothesis two
```{r models for hypothesis two}
summary(lmerTest::lmer(LPP ~ block * pos_affectivity + (1|pid), data = filter(per_erp_long, site == "left")))
summary(lmerTest::lmer(LPP ~ block * pos_affectivity + (1|pid), data = filter(per_erp_long, site == "center")))
summary(lmerTest::lmer(LPP ~ block * pos_affectivity + (1|pid), data = filter(per_erp_long, site == "right")))
```
Models for hypothesis three
```{r relevel block variable, include=FALSE}
per_erp_long$block <- relevel(per_erp_long$block, ref = "Pos_Watch")
```

```{r models for hypothesis three}
summary(lmerTest::lmer(LPP ~ block * savoring_moment + (1|pid), data = filter(per_erp_long, site == "left")))
summary(lmerTest::lmer(LPP ~ block * savoring_moment + (1|pid), data = filter(per_erp_long, site == "center")))
summary(lmerTest::lmer(LPP ~ block * savoring_moment + (1|pid), data = filter(per_erp_long, site == "right")))
```
